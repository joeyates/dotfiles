#!/usr/bin/env bash

PREFIX=$HOME/.password-store

die() {
  echo "$@" >&2
  exit 1
}

jgy_password() {
  [[ $# -eq 0 ]] && die "Usage: $0 match [match1 [match2] ...]"

  local terms="$(printf '%s.*?' "$@")"

  local passwords=$(
    find "$PREFIX" -name '*.gpg' -type f \
      | sed -r "s#^$PREFIX/##" \
      | sed -r "s#\.gpg\$##" \
      | sort
  )

  local matches=$(echo "$passwords" | grep -Pi "$terms")

  [[ -z "$matches" ]] && die "'$@' not found"

  local count=$(echo "$matches" | wc -l)

  if [[ $count -eq 1 ]]; then
    echo "$matches:"
    pass $matches
  else
    local choice=$(echo "$matches" | fzf)
    [[ -z "$choice" ]] && exit 1
    echo "$choice:"
    pass $choice
  fi
}

if which fzf >/dev/null ; then
  jgy_password "$@"
else
  die "fzf is not installed"
fi
exit $?
